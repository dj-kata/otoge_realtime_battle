<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDVX Helper Realtime Battle</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .hidden {
            display: none !important;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-screen {
            max-width: 400px;
            margin: 50px auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* ãƒ¡ã‚¤ãƒ³ç”»é¢ */
        .main-screen {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .main-screen.in-room {
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 1024px) {
            .main-screen {
                grid-template-columns: 1fr;
            }
        }

        /* éƒ¨å±‹ä¸€è¦§ãƒ»ä½œæˆ */
        .room-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .room-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .room-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .room-content {
            margin-right: 60px; /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        }

        .room-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .room-info {
            font-size: 14px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
        }

        .room-rule {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .room-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .room-delete-btn:hover {
            opacity: 1;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        .game-area {
            text-align: center;
        }

        .current-song {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rankings {
            margin-bottom: 20px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .rank {
            font-weight: bold;
            font-size: 20px;
            width: 40px;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .type-api { background: #007bff; color: white; }
        .type-web { background: #6c757d; color: white; }

        .score {
            font-weight: 600;
            font-size: 18px;
        }

        /* ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ */
        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            min-height: 60px;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .member-info span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        .owner-crown {
            color: #ffd700;
            font-weight: bold;
            flex-shrink: 0;
        }

        .role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .role-player { background: #28a745; color: white; }
        .role-spectator { background: #6c757d; color: white; }

        .points {
            font-weight: 600;
            color: #667eea;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* ãƒãƒ£ãƒƒãƒˆ */
        .chat-container {
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            background: #f8f9fa;
            margin-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .chat-username {
            font-weight: 600;
            color: #667eea;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
        }

        /* ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
        .test-area {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .test-area h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }

        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
        .flex {
            display: flex;
        }

        .flex-between {
            justify-content: space-between;
        }

        .flex-center {
            align-items: center;
        }

        .gap-10 {
            gap: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .text-center {
            text-align: center;
        }

        .full-width {
            width: 100%;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .main-screen {
                grid-template-columns: 1fr;
            }

            .room-content {
                margin-right: 50px;
            }

            .room-delete-btn {
                padding: 3px 6px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SDVX Helper Realtime Battle</h1>
            <p>ã‚¢ãƒªãƒ¼ãƒŠé¢¨ã®å¯¾æˆ¦ã«ä½¿ãˆã‚‹ã‹ã‚‚ï¼ŸBPLé¢¨ã®2äººå¯¾æˆ¦ãƒ“ãƒ¥ãƒ¼ã¨è¤‡æ•°äººã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°å½¢å¼ãƒ“ãƒ¥ãƒ¼ã‚’æ­è¼‰ã€‚</p>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="login-screen">
            <div class="card">
                <h2 class="text-center mb-20">ã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶š</h2>
                <div class="input-group">
                    <label for="usernameInput">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                    <input type="text" id="usernameInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›" maxlength="20">
                </div>
                <button id="connectBtn" class="btn full-width">æ¥ç¶š</button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
        <div id="mainScreen" class="main-screen hidden">
            <!-- å·¦å´: éƒ¨å±‹ä¸€è¦§ãƒ»ä½œæˆ -->
            <div id="lobbyArea" class="sidebar">
                <div class="card">
                    <h3 class="mb-20">éƒ¨å±‹ã‚’ä½œæˆ</h3>
                    <div class="input-group">
                        <label for="roomNameInput">éƒ¨å±‹å</label>
                        <input type="text" id="roomNameInput" placeholder="éƒ¨å±‹å" maxlength="30">
                    </div>
                    <div class="input-group">
                        <label for="ruleSelect">ãƒ«ãƒ¼ãƒ«</label>
                        <select id="ruleSelect">
                            <option value="normal">é€šå¸¸ã‚¹ã‚³ã‚¢</option>
                            <option value="ex">EXã‚¹ã‚³ã‚¢</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" maxlength="20">
                    </div>
                    <button id="createRoomBtn" class="btn full-width">éƒ¨å±‹ã‚’ä½œæˆ</button>
                </div>

                <div class="card">
                    <div class="flex flex-between flex-center mb-20">
                        <h3>éƒ¨å±‹ä¸€è¦§</h3>
                        <button id="refreshRoomsBtn" class="btn btn-small">æ›´æ–°</button>
                    </div>
                    <div id="roomList" class="room-list">
                        <!-- éƒ¨å±‹ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>

            <!-- ä¸­å¤®: ã‚²ãƒ¼ãƒ ç”»é¢ -->
            <div class="game-area">
                <div id="gameCard" class="card hidden">
                    <div class="flex flex-between flex-center mb-20">
                        <h2 id="roomTitle">éƒ¨å±‹å</h2>
                        <div>
                            <span id="roomRule" class="room-rule">é€šå¸¸ã‚¹ã‚³ã‚¢</span>
                        </div>
                    </div>

                    <div id="currentSongArea" class="hidden">
                        <div class="current-song">
                            <h3>ğŸµ ç¾åœ¨ãƒ—ãƒ¬ã‚¤ä¸­</h3>
                            <p>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚³ã‚¢å¾…ã¡...</p>
                        </div>
                    </div>

                    <div id="rankingsArea" class="rankings hidden">
                        <h3 class="mb-10">ğŸ† ç¾åœ¨ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                        <div id="rankingsList">
                            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>

                    <div id="songHistoryArea" class="hidden">
                        <h3 class="mb-10">ğŸ“š éå»ã®çµæœ</h3>
                        <div id="songHistory">
                            <!-- éå»ã®çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>

                    <!-- ãƒ­ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                    <div class="flex gap-10 mb-20">
                        <button id="becomePlayerBtn" class="btn">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãªã‚‹</button>
                        <button id="becomeSpectatorBtn" class="btn btn-secondary">è¦³æˆ¦è€…ã«ãªã‚‹</button>
                    </div>

                    <!-- å¯è¦–åŒ–ãƒ“ãƒ¥ãƒ¼ï¼ˆå…¨å“¡è¡¨ç¤ºï¼‰ -->
                    <div class="flex gap-10 mb-20">
                        <button id="openDuelVisualizerBtn" class="btn btn-small">2äººå¯¾æˆ¦ãƒ“ãƒ¥ãƒ¼</button>
                        <button id="openMultiVisualizerBtn" class="btn btn-small">å¤šäººæ•°ãƒ“ãƒ¥ãƒ¼</button>
                    </div>

                    <!-- éƒ¨å±‹ä¸»å°‚ç”¨ã‚¨ãƒªã‚¢ -->
                    <div id="ownerControls" class="hidden">
                        <h4 class="mb-10">ğŸ‘‘ éƒ¨å±‹ä¸»ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h4>
                        <div class="flex gap-10 mb-10">
                            <button id="resetPointsBtn" class="btn btn-secondary btn-small">ãƒã‚¤ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
                        </div>
                    </div>

                    <button id="leaveRoomBtn" class="btn btn-secondary full-width">éƒ¨å±‹ã‚’å‡ºã‚‹</button>

                    <!-- ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ (é–‹ç™ºç’°å¢ƒã®ã¿) -->
                    <div id="testArea" class="test-area hidden">
                        <h3>ğŸ§ª ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½</h3>
                        <p class="mb-10">é–‹ç™ºç’°å¢ƒã§ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™</p>
                        <div class="flex gap-10 mb-10">
                            <input type="number" id="testNormalScore" placeholder="é€šå¸¸ã‚¹ã‚³ã‚¢" style="flex: 1;">
                            <input type="number" id="testExScore" placeholder="EXã‚¹ã‚³ã‚¢" style="flex: 1;">
                        </div>
                        <div class="flex gap-10">
                            <button id="sendTestScoreBtn" class="btn btn-small">ã‚¹ã‚³ã‚¢é€ä¿¡</button>
                            <button id="finishTestSongBtn" class="btn btn-small">æ›²çµ‚äº†</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´: ãƒ¡ãƒ³ãƒãƒ¼ãƒ»ãƒãƒ£ãƒƒãƒˆ -->
            <div class="sidebar">
                <div id="membersCard" class="card hidden">
                    <h3 class="mb-20">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h3>
                    <div id="membersList">
                        <!-- ãƒ¡ãƒ³ãƒãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>

                <div id="chatCard" class="card hidden">
                    <h3 class="mb-10">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h3>
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages">
                            <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                        <div class="chat-input-container">
                            <input type="text" id="chatInput" class="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." maxlength="200">
                            <button id="sendChatBtn" class="btn">é€ä¿¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="passwordModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-center mb-20">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</h3>
            <div class="input-group">
                <label for="joinPasswordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="joinPasswordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
            </div>
            <div class="flex gap-10">
                <button id="cancelJoinBtn" class="btn btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirmJoinBtn" class="btn" style="flex: 1;">å…¥å®¤</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†è€…å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="adminDeleteModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-center mb-20">ğŸ›¡ï¸ ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™</h3>
            <p class="text-center mb-20" style="color: #6c757d;">ã“ã®éƒ¨å±‹ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™</p>
            <div class="mb-10">
                <strong>å‰Šé™¤å¯¾è±¡ï¼š</strong><span id="deleteTargetRoomName"></span>
            </div>
            <div class="input-group">
                <label for="adminPasswordInput">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="adminPasswordInput" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
            </div>
            <div class="flex gap-10">
                <button id="cancelAdminDeleteBtn" class="btn btn-secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirmAdminDeleteBtn" class="btn btn-danger" style="flex: 1;">å‰Šé™¤å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let socket;
        let currentUser = null;
        let currentRoom = null;
        let joinRoomId = null;
        let deleteTargetRoomId = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            socket = io();
            setupEventListeners();
            loadRoomList();

            // é–‹ç™ºç’°å¢ƒã‹ãƒã‚§ãƒƒã‚¯
            checkEnvironment();
        });

        function setupEventListeners() {
            // ãƒ­ã‚°ã‚¤ãƒ³
            document.getElementById('connectBtn').addEventListener('click', connect);
            document.getElementById('usernameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') connect();
            });

            // éƒ¨å±‹ä½œæˆ
            document.getElementById('createRoomBtn').addEventListener('click', createRoom);

            // éƒ¨å±‹æ›´æ–°
            document.getElementById('refreshRoomsBtn').addEventListener('click', loadRoomList);

            // ãƒ­ãƒ¼ãƒ«å¤‰æ›´
            document.getElementById('becomePlayerBtn').addEventListener('click', () => changeRole('player'));
            document.getElementById('becomeSpectatorBtn').addEventListener('click', () => changeRole('spectator'));

            // éƒ¨å±‹é€€å‡º
            document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);

            // éƒ¨å±‹ä¸»æ©Ÿèƒ½
            document.getElementById('resetPointsBtn').addEventListener('click', resetPoints);
            
            // å¯è¦–åŒ–ãƒ“ãƒ¥ãƒ¼ï¼ˆå…¨å“¡ï¼‰
            document.getElementById('openDuelVisualizerBtn').addEventListener('click', openDuelVisualizer);
            document.getElementById('openMultiVisualizerBtn').addEventListener('click', openMultiVisualizer);

            // ãƒãƒ£ãƒƒãƒˆ
            document.getElementById('sendChatBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('cancelJoinBtn').addEventListener('click', hidePasswordModal);
            document.getElementById('confirmJoinBtn').addEventListener('click', joinRoomWithPassword);
            document.getElementById('joinPasswordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoomWithPassword();
            });

            // ç®¡ç†è€…å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('cancelAdminDeleteBtn').addEventListener('click', hideAdminDeleteModal);
            document.getElementById('confirmAdminDeleteBtn').addEventListener('click', executeAdminDelete);
            document.getElementById('adminPasswordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') executeAdminDelete();
            });

            // ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
            document.getElementById('sendTestScoreBtn').addEventListener('click', sendTestScore);
            document.getElementById('finishTestSongBtn').addEventListener('click', finishTestSong);
        }

        function setupSocketListeners() {
            socket.on('connected', (data) => {
                currentUser = data;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                loadRoomList();
            });

            socket.on('roomCreated', (data) => {
                loadRoomList();
            });

            socket.on('roomListUpdated', () => {
                loadRoomList();
            });

            socket.on('joinedRoom', (data) => {
                currentRoom = data.room;
                showGameScreen();
                updateMembersList(data.members);
                
                // éå»ã®å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ–°ã—ã„éƒ¨å±‹ã®å±¥æ­´ã‚’è¡¨ç¤º
                clearSongHistory();
                if (data.songHistory && data.songHistory.length > 0) {
                    data.songHistory.forEach(song => {
                        const rankings = song.calculateRankings ? song.calculateRankings(data.room.rule) : song.rankings;
                        if (rankings) {
                            addSongHistory(rankings);
                        }
                    });
                    document.getElementById('songHistoryArea').classList.remove('hidden');
                }
                
                if (data.currentSong) {
                    showCurrentSong();
                }
                
                // è‡ªåˆ†ã®ãƒ­ãƒ¼ãƒ«ã‚’ãƒœã‚¿ãƒ³ã«åæ˜ 
                const currentMember = data.members.find(m => m.id === currentUser.userId);
                if (currentMember) {
                    updateRoleButtons(currentMember.role);
                    console.log(`Joined room as ${currentMember.role}`);
                }
            });

            socket.on('memberJoined', (member) => {
                console.log('Member joined:', member);
                addMemberToList(member);
            });

            socket.on('memberLeft', (data) => {
                console.log('Member left:', data);
                removeMemberFromList(data.userId);
            });

            socket.on('memberKicked', (data) => {
                removeMemberFromList(data.userId);
                if (data.userId === currentUser.userId) {
                    alert('éƒ¨å±‹ã‹ã‚‰é€€å‡ºã•ã›ã‚‰ã‚Œã¾ã—ãŸ');
                    hideGameScreen();
                }
            });

            socket.on('roleChanged', (data) => {
                updateMemberRole(data.userId, data.role);
                if (data.userId === currentUser.userId) {
                    updateRoleButtons(data.role);
                }
                console.log(`Role changed: ${data.username} is now ${data.role}`);
            });

            socket.on('scoreUpdated', (data) => {
                console.log('Score updated:', data);
            });

            socket.on('rankingsUpdated', (rankings) => {
                updateRankings(rankings);
            });

            socket.on('userFinished', (data) => {
                console.log('User finished:', data);
            });

            socket.on('songFinished', (data) => {
                hideConcurrentSong();
                updateMembersList(data.members);
                addSongHistory(data.rankings);
            });

            socket.on('pointsReset', (data) => {
                updateMembersList(data.members);
                alert('ãƒã‚¤ãƒ³ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ');
            });

            socket.on('roomDeleted', () => {
                alert('éƒ¨å±‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                hideGameScreen();
                loadRoomList();
            });

            socket.on('newMessage', (message) => {
                addChatMessage(message);
            });

            socket.on('kicked', () => {
                alert('éƒ¨å±‹ã‹ã‚‰é€€å‡ºã•ã›ã‚‰ã‚Œã¾ã—ãŸ');
                hideGameScreen();
            });

            socket.on('error', (data) => {
                alert('ã‚¨ãƒ©ãƒ¼: ' + data.message);
            });
        }

        function connect() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            setupSocketListeners();
            socket.emit('webConnect', { username });
        }

        function createRoom() {
            const name = document.getElementById('roomNameInput').value.trim();
            const rule = document.getElementById('ruleSelect').value;
            const password = document.getElementById('passwordInput').value.trim() || null;

            if (!name) {
                alert('éƒ¨å±‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            socket.emit('createRoom', { name, rule, password });

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('roomNameInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        function loadRoomList() {
            fetch('/api/rooms')
                .then(response => response.json())
                .then(rooms => {
                    const roomList = document.getElementById('roomList');
                    roomList.innerHTML = '';

                    if (rooms.length === 0) {
                        roomList.innerHTML = '<p style="text-align: center; color: #6c757d;">éƒ¨å±‹ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                        return;
                    }

                    rooms.forEach(room => {
                        const roomElement = createRoomElement(room);
                        roomList.appendChild(roomElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading rooms:', error);
                });
        }

        function createRoomElement(room) {
            const div = document.createElement('div');
            div.className = 'room-item';
            
            // éƒ¨å±‹ã®å†…å®¹éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å…¥å®¤
            div.onclick = (e) => {
                // å‰Šé™¤ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯å…¥å®¤å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (e.target.classList.contains('room-delete-btn')) {
                    return;
                }
                joinRoom(room.id, room.hasPassword);
            };

            div.innerHTML = `
                <div class="room-content">
                    <div class="room-name">${room.name}</div>
                    <div class="room-info">
                        <span class="room-rule">${room.rule === 'ex' ? 'EXã‚¹ã‚³ã‚¢' : 'é€šå¸¸ã‚¹ã‚³ã‚¢'}</span>
                        <span>${room.memberCount}äºº ${room.hasPassword ? 'ğŸ”’' : ''}</span>
                    </div>
                </div>
                <button class="room-delete-btn" onclick="showAdminDeleteModal('${room.id}', '${room.name}')" title="ç®¡ç†è€…å‰Šé™¤">ğŸ—‘ï¸</button>
            `;

            return div;
        }

        function joinRoom(roomId, hasPassword) {
            joinRoomId = roomId;

            if (hasPassword) {
                showPasswordModal();
            } else {
                socket.emit('joinRoom', { roomId, password: null });
            }
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('joinPasswordInput').focus();
        }

        function hidePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('joinPasswordInput').value = '';
            joinRoomId = null;
        }

        function joinRoomWithPassword() {
            const password = document.getElementById('joinPasswordInput').value;
            socket.emit('joinRoom', { roomId: joinRoomId, password });
            hidePasswordModal();
        }

        function showAdminDeleteModal(roomId, roomName) {
            deleteTargetRoomId = roomId;
            document.getElementById('deleteTargetRoomName').textContent = roomName;
            document.getElementById('adminDeleteModal').classList.remove('hidden');
            document.getElementById('adminPasswordInput').focus();
        }

        function hideAdminDeleteModal() {
            document.getElementById('adminDeleteModal').classList.add('hidden');
            document.getElementById('adminPasswordInput').value = '';
            deleteTargetRoomId = null;
        }

        function executeAdminDelete() {
            const adminPassword = document.getElementById('adminPasswordInput').value;
            
            if (!adminPassword) {
                alert('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!deleteTargetRoomId) {
                alert('å‰Šé™¤å¯¾è±¡ã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                hideAdminDeleteModal();
                return;
            }

            const roomName = document.getElementById('deleteTargetRoomName').textContent;
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (!confirm(`éƒ¨å±‹ã€Œ${roomName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            // ç®¡ç†è€…å‰Šé™¤APIå‘¼ã³å‡ºã—
            fetch(`/api/admin/rooms/${deleteTargetRoomId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    adminPassword: adminPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('éƒ¨å±‹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                    hideAdminDeleteModal();
                    loadRoomList(); // éƒ¨å±‹ä¸€è¦§ã‚’æ›´æ–°
                } else {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            })
            .catch(error => {
                console.error('Admin delete error:', error);
                alert('éƒ¨å±‹ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        }

        function showGameScreen() {
            document.getElementById('gameCard').classList.remove('hidden');
            document.getElementById('membersCard').classList.remove('hidden');
            document.getElementById('chatCard').classList.remove('hidden');
            
            // ãƒ­ãƒ“ãƒ¼ã‚¨ãƒªã‚¢ã‚’éš ã™
            document.getElementById('lobbyArea').classList.add('hidden');
            
            // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤‰æ›´
            document.getElementById('mainScreen').classList.add('in-room');

            // éƒ¨å±‹æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('roomTitle').textContent = currentRoom.name;
            document.getElementById('roomRule').textContent = currentRoom.rule === 'ex' ? 'EXã‚¹ã‚³ã‚¢' : 'é€šå¸¸ã‚¹ã‚³ã‚¢';

            // éƒ¨å±‹ä¸»ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒã‚¤ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆã®ã¿è¡¨ç¤ºï¼‰
            if (currentRoom.ownerId === currentUser.userId) {
                document.getElementById('ownerControls').classList.remove('hidden');
            } else {
                document.getElementById('ownerControls').classList.add('hidden');
            }

            // å„ã‚¨ãƒªã‚¢ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
            clearSongHistory();
            clearRankings();
            clearChat();
            hideConcurrentSong();
            
            updateRoleButtons('spectator');
        }

        function hideGameScreen() {
            document.getElementById('gameCard').classList.add('hidden');
            document.getElementById('membersCard').classList.add('hidden');
            document.getElementById('chatCard').classList.add('hidden');
            
            // ãƒ­ãƒ“ãƒ¼ã‚¨ãƒªã‚¢ã‚’å†è¡¨ç¤º
            document.getElementById('lobbyArea').classList.remove('hidden');
            
            // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å…ƒã«æˆ»ã™
            document.getElementById('mainScreen').classList.remove('in-room');
            
            // å„ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            clearSongHistory();
            clearRankings();
            clearChat();
            
            currentRoom = null;
        }

        // æ–°ã—ã„ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’è¿½åŠ 
        function clearSongHistory() {
            const songHistory = document.getElementById('songHistory');
            songHistory.innerHTML = '';
            document.getElementById('songHistoryArea').classList.add('hidden');
        }

        function clearRankings() {
            const rankingsList = document.getElementById('rankingsList');
            rankingsList.innerHTML = '';
            document.getElementById('rankingsArea').classList.add('hidden');
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
        }

        function changeRole(role) {
            socket.emit('changeRole', { role });
        }

        function updateRoleButtons(role) {
            const playerBtn = document.getElementById('becomePlayerBtn');
            const spectatorBtn = document.getElementById('becomeSpectatorBtn');

            if (role === 'player') {
                playerBtn.disabled = true;
                spectatorBtn.disabled = false;
                playerBtn.textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸­';
                spectatorBtn.textContent = 'è¦³æˆ¦è€…ã«ãªã‚‹';
            } else {
                playerBtn.disabled = false;
                spectatorBtn.disabled = true;
                playerBtn.textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãªã‚‹';
                spectatorBtn.textContent = 'è¦³æˆ¦ä¸­';
            }
        }

        function leaveRoom() {
            if (confirm('éƒ¨å±‹ã‚’å‡ºã¾ã™ã‹ï¼Ÿ')) {
                socket.emit('leaveRoom');
                hideGameScreen();
                loadRoomList();
            }
        }

        function resetPoints() {
            if (confirm('å…¨å“¡ã®ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                socket.emit('resetPoints');
            }
        }

        function updateMembersList(members) {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';

            members.forEach(member => {
                addMemberToList(member);
            });
        }

        function addMemberToList(member) {
            const membersList = document.getElementById('membersList');
            const existingMember = document.getElementById(`member-${member.id}`);
            
            if (existingMember) {
                existingMember.remove();
            }

            const div = document.createElement('div');
            div.className = 'member-item';
            div.id = `member-${member.id}`;

            const isOwner = currentRoom && currentRoom.ownerId === member.id;
            const isCurrentUser = currentUser && currentUser.userId === member.id;

            div.innerHTML = `
                <div class="member-info">
                    ${isOwner ? '<span class="owner-crown">ğŸ‘‘</span>' : ''}
                    <span>${member.username}${isCurrentUser ? ' (ã‚ãªãŸ)' : ''}</span>
                    <span class="player-type type-${member.type}">${member.type.toUpperCase()}</span>
                    <span class="role-badge role-${member.role}">${member.role === 'player' ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'è¦³æˆ¦è€…'}</span>
                </div>
                <div class="member-controls">
                    <span class="points">${member.points}pt</span>
                    ${canControlMember(member) ? `
                        <button onclick="changeMemberRole('${member.id}', '${member.role === 'player' ? 'spectator' : 'player'}')" 
                                class="btn btn-small">åˆ‡æ›¿</button>
                    ` : ''}
                    ${canKickMember(member) ? `
                        <button onclick="kickMember('${member.id}')" 
                                class="btn btn-danger btn-small">è¿½æ”¾</button>
                    ` : ''}
                </div>
            `;

            membersList.appendChild(div);
        }

        function removeMemberFromList(userId) {
            const memberElement = document.getElementById(`member-${userId}`);
            if (memberElement) {
                memberElement.remove();
            }
        }

        function updateMemberRole(userId, role) {
            const memberElement = document.getElementById(`member-${userId}`);
            if (memberElement) {
                const roleBadge = memberElement.querySelector('.role-badge');
                if (roleBadge) {
                    roleBadge.className = `role-badge role-${role}`;
                    roleBadge.textContent = role === 'player' ? 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼' : 'è¦³æˆ¦è€…';
                }

                // ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
                const controlButton = memberElement.querySelector('[onclick*="changeMemberRole"]');
                if (controlButton) {
                    const newRole = role === 'player' ? 'spectator' : 'player';
                    controlButton.onclick = () => changeMemberRole(userId, newRole);
                    controlButton.textContent = 'åˆ‡æ›¿';
                }
            }
        }

        function canControlMember(member) {
            const canControl = currentRoom && currentRoom.ownerId === currentUser.userId && 
                   member.id !== currentUser.userId && member.type === 'api';
            
            if (currentRoom && currentRoom.ownerId === currentUser.userId) {
                console.log(`Control check for ${member.username}: type=${member.type}, canControl=${canControl}`);
            }
            
            return canControl;
        }

        function canKickMember(member) {
            return currentRoom && currentRoom.ownerId === currentUser.userId && 
                   member.id !== currentUser.userId;
        }

        function changeMemberRole(targetUserId, newRole) {
            console.log(`Attempting to change role of user ${targetUserId} to ${newRole}`);
            socket.emit('changeMemberRole', { targetUserId, role: newRole });
        }

        function kickMember(targetUserId) {
            if (confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½æ”¾ã—ã¾ã™ã‹ï¼Ÿ')) {
                socket.emit('kickMember', { targetUserId });
            }
        }

        function showCurrentSong() {
            document.getElementById('currentSongArea').classList.remove('hidden');
            document.getElementById('rankingsArea').classList.remove('hidden');
        }

        function hideConcurrentSong() {
            document.getElementById('currentSongArea').classList.add('hidden');
            document.getElementById('rankingsArea').classList.add('hidden');
        }

        function updateRankings(rankings) {
            const rankingsList = document.getElementById('rankingsList');
            rankingsList.innerHTML = '';

            console.log('Updating rankings:', rankings);

            rankings.forEach((ranking, index) => {
                const div = document.createElement('div');
                div.className = 'ranking-item';

                div.innerHTML = `
                    <div class="rank rank-${ranking.rank}">#${ranking.rank}</div>
                    <div class="player-info">
                        <span>${ranking.username}</span>
                        <span class="player-type type-${ranking.type}">${ranking.type.toUpperCase()}</span>
                    </div>
                    <div class="score">${ranking.score.toLocaleString()}</div>
                `;

                rankingsList.appendChild(div);
            });

            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
            document.getElementById('rankingsArea').classList.remove('hidden');
            document.getElementById('currentSongArea').classList.remove('hidden');
        }

        function addSongHistory(rankings) {
            const songHistory = document.getElementById('songHistory');
            
            const div = document.createElement('div');
            div.className = 'card';
            div.style.marginBottom = '10px';
            div.style.background = '#f8f9fa';
            
            let historyHTML = '<h5>ğŸ æ›²çµ‚äº†</h5>';
            rankings.forEach((ranking, index) => {
                const points = index === 0 ? 2 : index === 1 ? 1 : 0;
                historyHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0;">
                        <span>#${ranking.rank} ${ranking.username}</span>
                        <span>${ranking.score.toLocaleString()} (+${points}pt)</span>
                    </div>
                `;
            });
            
            div.innerHTML = historyHTML;
            songHistory.insertBefore(div, songHistory.firstChild);
            
            document.getElementById('songHistoryArea').classList.remove('hidden');
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            socket.emit('sendMessage', { message });
            input.value = '';
        }

        function addChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            const div = document.createElement('div');
            div.className = 'chat-message';
            
            const time = new Date(message.timestamp).toLocaleTimeString();
            div.innerHTML = `
                <span class="chat-username">${message.username}</span>
                <span style="font-size: 12px; color: #6c757d; margin-left: 10px;">${time}</span>
                <div style="margin-top: 3px;">${message.message}</div>
            `;
            
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function checkEnvironment() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’åˆ¤å®šï¼ˆæœ¬æ¥ã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ï¼‰
            const isProduction = !window.location.hostname.includes('localhost') && 
                                !window.location.hostname.includes('127.0.0.1') &&
                                !window.location.search.includes('test=1');
            
            if (!isProduction) {
                document.getElementById('testArea').classList.remove('hidden');
            }
        }

        function sendTestScore() {
            const normalScore = parseInt(document.getElementById('testNormalScore').value) || 0;
            const exScore = parseInt(document.getElementById('testExScore').value) || 0;
            
            if (normalScore === 0 && exScore === 0) {
                alert('ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            socket.emit('sendTestScore', { normalScore, exScore });
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('testNormalScore').value = '';
            document.getElementById('testExScore').value = '';
        }

        function finishTestSong() {
            socket.emit('finishTestSong');
        }

        function openDuelVisualizer() {
            if (currentRoom) {
                const url = `/duel.html?room=${currentRoom.id}`;
                window.open(url, '_blank', 'width=1200,height=800');
            }
        }

        function openMultiVisualizer() {
            if (currentRoom) {
                const url = `/multi.html?room=${currentRoom.id}`;
                window.open(url, '_blank', 'width=1200,height=600');
            }
        }
    </script>
</body>
</html>