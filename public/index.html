<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDVX Helper Realtime Battle</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .hidden {
            display: none !important;
        }

        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
        .login-screen {
            max-width: 400px;
            margin: 50px auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* „É°„Ç§„É≥ÁîªÈù¢ */
        .main-screen {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .main-screen.in-room {
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 1024px) {
            .main-screen {
                grid-template-columns: 1fr;
            }
        }

        /* ÈÉ®Â±ã‰∏ÄË¶ß„Éª‰ΩúÊàê */
        .room-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .room-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .room-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .room-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .room-info {
            font-size: 14px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
        }

        .room-rule {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* „Ç≤„Éº„É†ÁîªÈù¢ */
        .game-area {
            text-align: center;
        }

        .current-song {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rankings {
            margin-bottom: 20px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .rank {
            font-weight: bold;
            font-size: 20px;
            width: 40px;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .type-api { background: #007bff; color: white; }
        .type-web { background: #6c757d; color: white; }

        .score {
            font-weight: 600;
            font-size: 18px;
        }

        /* „É°„É≥„Éê„Éº„É™„Çπ„Éà */
        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            min-height: 60px;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0; /* flex„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Åµ„Çå„ÇíÂá¶ÁêÜ„Åß„Åç„Çã„Çà„ÅÜ„Å´ */
        }

        .member-info span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        .owner-crown {
            color: #ffd700;
            font-weight: bold;
            flex-shrink: 0;
        }

        .role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .role-player { background: #28a745; color: white; }
        .role-spectator { background: #6c757d; color: white; }

        .points {
            font-weight: 600;
            color: #667eea;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* „ÉÅ„É£„ÉÉ„Éà */
        .chat-container {
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            background: #f8f9fa;
            margin-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .chat-username {
            font-weight: 600;
            color: #667eea;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
        }

        /* „ÉÜ„Çπ„Éà„Ç®„É™„Ç¢ */
        .test-area {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .test-area h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }

        /* „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ */
        .flex {
            display: flex;
        }

        .flex-between {
            justify-content: space-between;
        }

        .flex-center {
            align-items: center;
        }

        .gap-10 {
            gap: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .text-center {
            text-align: center;
        }

        .full-width {
            width: 100%;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .main-screen {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SDVX Helper Realtime Battle</h1>
            <p>„Ç¢„É™„Éº„ÉäÈ¢®„ÅÆÂØæÊà¶„Å´‰Ωø„Åà„Çã„Åã„ÇÇÔºüBPLÈ¢®„ÅÆ2‰∫∫ÂØæÊà¶„Éì„É•„Éº„Å®Ë§áÊï∞‰∫∫„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞ÂΩ¢Âºè„Éì„É•„Éº„ÇíÊê≠Ëºâ„ÄÇ</p>
        </div>

        <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
        <div id="loginScreen" class="login-screen">
            <div class="card">
                <h2 class="text-center mb-20">„Ç∑„Çπ„ÉÜ„É†„Å´Êé•Á∂ö</h2>
                <div class="input-group">
                    <label for="usernameInput">„É¶„Éº„Ç∂„ÉºÂêç</label>
                    <input type="text" id="usernameInput" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ" maxlength="20">
                </div>
                <button id="connectBtn" class="btn full-width">Êé•Á∂ö</button>
            </div>
        </div>

        <!-- „É°„Ç§„É≥ÁîªÈù¢ -->
        <div id="mainScreen" class="main-screen hidden">
            <!-- Â∑¶ÂÅ¥: ÈÉ®Â±ã‰∏ÄË¶ß„Éª‰ΩúÊàê -->
            <div id="lobbyArea" class="sidebar">
                <div class="card">
                    <h3 class="mb-20">ÈÉ®Â±ã„Çí‰ΩúÊàê</h3>
                    <div class="input-group">
                        <label for="roomNameInput">ÈÉ®Â±ãÂêç</label>
                        <input type="text" id="roomNameInput" placeholder="ÈÉ®Â±ãÂêç" maxlength="30">
                    </div>
                    <div class="input-group">
                        <label for="ruleSelect">„É´„Éº„É´</label>
                        <select id="ruleSelect">
                            <option value="normal">ÈÄöÂ∏∏„Çπ„Ç≥„Ç¢</option>
                            <option value="ex">EX„Çπ„Ç≥„Ç¢</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="passwordInput">„Éë„Çπ„ÉØ„Éº„ÉâÔºà‰ªªÊÑèÔºâ</label>
                        <input type="text" id="passwordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" maxlength="20">
                    </div>
                    <button id="createRoomBtn" class="btn full-width">ÈÉ®Â±ã„Çí‰ΩúÊàê</button>
                </div>

                <div class="card">
                    <div class="flex flex-between flex-center mb-20">
                        <h3>ÈÉ®Â±ã‰∏ÄË¶ß</h3>
                        <button id="refreshRoomsBtn" class="btn btn-small">Êõ¥Êñ∞</button>
                    </div>
                    <div id="roomList" class="room-list">
                        <!-- ÈÉ®Â±ã‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>
            </div>

            <!-- ‰∏≠Â§Æ: „Ç≤„Éº„É†ÁîªÈù¢ -->
            <div class="game-area">
                <div id="gameCard" class="card hidden">
                    <div class="flex flex-between flex-center mb-20">
                        <h2 id="roomTitle">ÈÉ®Â±ãÂêç</h2>
                        <div>
                            <span id="roomRule" class="room-rule">ÈÄöÂ∏∏„Çπ„Ç≥„Ç¢</span>
                        </div>
                    </div>

                    <!-- „É≠„Éº„É´Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ -->
                    <div class="flex gap-10 mb-20">
                        <button id="becomePlayerBtn" class="btn">„Éó„É¨„Ç§„É§„Éº„Å´„Å™„Çã</button>
                        <button id="becomeSpectatorBtn" class="btn btn-secondary">Ë¶≥Êà¶ËÄÖ„Å´„Å™„Çã</button>
                    </div>

                    <!-- ÂèØË¶ñÂåñ„Éì„É•„ÉºÔºàÂÖ®Âì°Ë°®Á§∫Ôºâ -->
                    <div class="flex gap-10 mb-20">
                        <button id="openDuelVisualizerBtn" class="btn btn-small">2‰∫∫ÂØæÊà¶„Éì„É•„Éº</button>
                        <button id="openMultiVisualizerBtn" class="btn btn-small">Â§ö‰∫∫Êï∞„Éì„É•„Éº</button>
                    </div>

                    <!-- ÈÉ®Â±ã‰∏ªÂ∞ÇÁî®„Ç®„É™„Ç¢ -->
                    <div id="ownerControls" class="hidden">
                        <h4 class="mb-10">üëë ÈÉ®Â±ã‰∏ª„É°„Éã„É•„Éº</h4>
                        <div class="flex gap-10 mb-10">
                            <button id="resetPointsBtn" class="btn btn-secondary btn-small">„Éù„Ç§„É≥„Éà„É™„Çª„ÉÉ„Éà</button>
                        </div>
                    </div>

                    <button id="leaveRoomBtn" class="btn btn-secondary full-width">ÈÉ®Â±ã„ÇíÂá∫„Çã</button>

                    <div id="currentSongArea" class="hidden">
                        <div class="current-song">
                            <h3>üìÄ ÁèæÂú®„Éó„É¨„Ç§‰∏≠</h3>
                            <p>„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çπ„Ç≥„Ç¢ÂæÖ„Å°...</p>
                        </div>
                    </div>

                    <div id="rankingsArea" class="rankings hidden">
                        <h3 class="mb-10">üèÜ ÁèæÂú®„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞</h3>
                        <div id="rankingsList">
                            <!-- „É©„É≥„Ç≠„É≥„Ç∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>

                    <div id="songHistoryArea" class="hidden">
                        <h3 class="mb-10">üìö ÈÅéÂéª„ÅÆÁµêÊûú</h3>
                        <div id="songHistory">
                            <!-- ÈÅéÂéª„ÅÆÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                    </div>

                    <!-- „ÉÜ„Çπ„Éà„Ç®„É™„Ç¢ (ÈñãÁô∫Áí∞Â¢É„ÅÆ„Åø) -->
                    <div id="testArea" class="test-area hidden">
                        <h3>üß™ „ÉÜ„Çπ„ÉàÊ©üËÉΩ</h3>
                        <p class="mb-10">ÈñãÁô∫Áí∞Â¢É„Åß„ÅÆ„ÅøÂà©Áî®ÂèØËÉΩ„Åß„Åô</p>
                        <div class="flex gap-10 mb-10">
                            <input type="number" id="testNormalScore" placeholder="ÈÄöÂ∏∏„Çπ„Ç≥„Ç¢" style="flex: 1;">
                            <input type="number" id="testExScore" placeholder="EX„Çπ„Ç≥„Ç¢" style="flex: 1;">
                        </div>
                        <div class="flex gap-10">
                            <button id="sendTestScoreBtn" class="btn btn-small">„Çπ„Ç≥„Ç¢ÈÄÅ‰ø°</button>
                            <button id="finishTestSongBtn" class="btn btn-small">Êõ≤ÁµÇ‰∫Ü</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Âè≥ÂÅ¥: „É°„É≥„Éê„Éº„Éª„ÉÅ„É£„ÉÉ„Éà -->
            <div class="sidebar">
                <div id="membersCard" class="card hidden">
                    <h3 class="mb-20">üë• „É°„É≥„Éê„Éº‰∏ÄË¶ß</h3>
                    <div id="membersList">
                        <!-- „É°„É≥„Éê„Éº„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>

                <div id="chatCard" class="card hidden">
                    <h3 class="mb-10">üí¨ „ÉÅ„É£„ÉÉ„Éà</h3>
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages">
                            <!-- „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                        </div>
                        <div class="chat-input-container">
                            <input type="text" id="chatInput" class="chat-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." maxlength="200">
                            <button id="sendChatBtn" class="btn">ÈÄÅ‰ø°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
    <div id="passwordModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-center mb-20">„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô</h3>
            <div class="input-group">
                <label for="joinPasswordInput">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                <input type="password" id="joinPasswordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
            </div>
            <div class="flex gap-10">
                <button id="cancelJoinBtn" class="btn btn-secondary" style="flex: 1;">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="confirmJoinBtn" class="btn" style="flex: 1;">ÂÖ•ÂÆ§</button>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let socket;
        let currentUser = null;
        let currentRoom = null;
        let joinRoomId = null;

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            socket = io();
            setupEventListeners();
            loadRoomList();

            // ÈñãÁô∫Áí∞Â¢É„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            checkEnvironment();
        });

        function setupEventListeners() {
            // „É≠„Ç∞„Ç§„É≥
            document.getElementById('connectBtn').addEventListener('click', connect);
            document.getElementById('usernameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') connect();
            });

            // ÈÉ®Â±ã‰ΩúÊàê
            document.getElementById('createRoomBtn').addEventListener('click', createRoom);

            // ÈÉ®Â±ãÊõ¥Êñ∞
            document.getElementById('refreshRoomsBtn').addEventListener('click', loadRoomList);

            // „É≠„Éº„É´Â§âÊõ¥
            document.getElementById('becomePlayerBtn').addEventListener('click', () => changeRole('player'));
            document.getElementById('becomeSpectatorBtn').addEventListener('click', () => changeRole('spectator'));

            // ÈÉ®Â±ãÈÄÄÂá∫
            document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);

            // ÈÉ®Â±ã‰∏ªÊ©üËÉΩ
            document.getElementById('resetPointsBtn').addEventListener('click', resetPoints);
            
            // ÂèØË¶ñÂåñ„Éì„É•„ÉºÔºàÂÖ®Âì°Ôºâ
            document.getElementById('openDuelVisualizerBtn').addEventListener('click', openDuelVisualizer);
            document.getElementById('openMultiVisualizerBtn').addEventListener('click', openMultiVisualizer);

            // „ÉÅ„É£„ÉÉ„Éà
            document.getElementById('sendChatBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // „Éë„Çπ„ÉØ„Éº„Éâ„É¢„Éº„ÉÄ„É´
            document.getElementById('cancelJoinBtn').addEventListener('click', hidePasswordModal);
            document.getElementById('confirmJoinBtn').addEventListener('click', joinRoomWithPassword);
            document.getElementById('joinPasswordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoomWithPassword();
            });

            // „ÉÜ„Çπ„ÉàÊ©üËÉΩ
            document.getElementById('sendTestScoreBtn').addEventListener('click', sendTestScore);
            document.getElementById('finishTestSongBtn').addEventListener('click', finishTestSong);
        }

        function setupSocketListeners() {
            socket.on('connected', (data) => {
                currentUser = data;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                loadRoomList();
            });

            socket.on('roomCreated', (data) => {
                loadRoomList();
            });

            socket.on('roomListUpdated', () => {
                loadRoomList();
            });

            socket.on('joinedRoom', (data) => {
                currentRoom = data.room;
                showGameScreen();
                updateMembersList(data.members);
    
                // ÈÅéÂéª„ÅÆÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâÊñ∞„Åó„ÅÑÈÉ®Â±ã„ÅÆÂ±•Ê≠¥„ÇíË°®Á§∫
                clearSongHistory();
                if (data.songHistory && data.songHistory.length > 0) {
                    data.songHistory.forEach(song => {
                        const rankings = song.calculateRankings ? song.calculateRankings(data.room.rule) : song.rankings;
                        if (rankings) {
                            addSongHistory(rankings);
                        }
                    });
                    document.getElementById('songHistoryArea').classList.remove('hidden');
                }
    
                if (data.currentSong) {
                    showCurrentSong();
                }
    
                // Ëá™ÂàÜ„ÅÆ„É≠„Éº„É´„Çí„Éú„Çø„É≥„Å´ÂèçÊò†
                const currentMember = data.members.find(m => m.id === currentUser.userId);
                if (currentMember) {
                    updateRoleButtons(currentMember.role);
                    console.log(`Joined room as ${currentMember.role}`);
                }
            });

            socket.on('memberJoined', (member) => {
                console.log('Member joined:', member);
                addMemberToList(member);
            });

            socket.on('memberLeft', (data) => {
                console.log('Member left:', data);
                removeMemberFromList(data.userId);
            });

            socket.on('memberKicked', (data) => {
                removeMemberFromList(data.userId);
                if (data.userId === currentUser.userId) {
                    alert('ÈÉ®Â±ã„Åã„ÇâÈÄÄÂá∫„Åï„Åõ„Çâ„Çå„Åæ„Åó„Åü');
                    hideGameScreen();
                }
            });

            socket.on('roleChanged', (data) => {
                updateMemberRole(data.userId, data.role);
                if (data.userId === currentUser.userId) {
                    updateRoleButtons(data.role);
                }
                console.log(`Role changed: ${data.username} is now ${data.role}`);
            });

            socket.on('scoreUpdated', (data) => {
                console.log('Score updated:', data);
                // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞„ÇíË¶ñË¶öÁöÑ„Å´Ë°®Á§∫ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
            });

            socket.on('rankingsUpdated', (rankings) => {
                updateRankings(rankings);
            });

            socket.on('userFinished', (data) => {
                // „É¶„Éº„Ç∂„ÉºÁµÇ‰∫Ü„ÅÆÂá¶ÁêÜ
                console.log('User finished:', data);
            });

            socket.on('songFinished', (data) => {
                hideConcurrentSong();
                updateMembersList(data.members);
                addSongHistory(data.rankings);
            });

            socket.on('pointsReset', (data) => {
                updateMembersList(data.members);
                alert('„Éù„Ç§„É≥„Éà„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü');
            });

            socket.on('roomDeleted', () => {
                alert('ÈÉ®Â±ã„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü');
                hideGameScreen();
                loadRoomList();
            });

            socket.on('newMessage', (message) => {
                addChatMessage(message);
            });

            socket.on('kicked', () => {
                alert('ÈÉ®Â±ã„Åã„ÇâÈÄÄÂá∫„Åï„Åõ„Çâ„Çå„Åæ„Åó„Åü');
                hideGameScreen();
            });

            socket.on('error', (data) => {
                alert('„Ç®„É©„Éº: ' + data.message);
            });
        }

        function connect() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            setupSocketListeners();
            socket.emit('webConnect', { username });
        }

        function createRoom() {
            const name = document.getElementById('roomNameInput').value.trim();
            const rule = document.getElementById('ruleSelect').value;
            const password = document.getElementById('passwordInput').value.trim() || null;

            if (!name) {
                alert('ÈÉ®Â±ãÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            socket.emit('createRoom', { name, rule, password });

            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('roomNameInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        function loadRoomList() {
            fetch('/api/rooms')
                .then(response => response.json())
                .then(rooms => {
                    const roomList = document.getElementById('roomList');
                    roomList.innerHTML = '';

                    if (rooms.length === 0) {
                        roomList.innerHTML = '<p style="text-align: center; color: #6c757d;">ÈÉ®Â±ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                        return;
                    }

                    rooms.forEach(room => {
                        const roomElement = createRoomElement(room);
                        roomList.appendChild(roomElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading rooms:', error);
                });
        }

        function createRoomElement(room) {
            const div = document.createElement('div');
            div.className = 'room-item';
            div.onclick = () => joinRoom(room.id, room.hasPassword);

            div.innerHTML = `
                <div class="room-name">${room.name}</div>
                <div class="room-info">
                    <span class="room-rule">${room.rule === 'ex' ? 'EX„Çπ„Ç≥„Ç¢' : 'ÈÄöÂ∏∏„Çπ„Ç≥„Ç¢'}</span>
                    <span>${room.memberCount}‰∫∫ ${room.hasPassword ? 'üîí' : ''}</span>
                </div>
            `;

            return div;
        }

        function joinRoom(roomId, hasPassword) {
            joinRoomId = roomId;

            if (hasPassword) {
                showPasswordModal();
            } else {
                socket.emit('joinRoom', { roomId, password: null });
            }
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('joinPasswordInput').focus();
        }

        function hidePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('joinPasswordInput').value = '';
            joinRoomId = null;
        }

        function joinRoomWithPassword() {
            const password = document.getElementById('joinPasswordInput').value;
            socket.emit('joinRoom', { roomId: joinRoomId, password });
            hidePasswordModal();
        }

        function showGameScreen() {
            document.getElementById('gameCard').classList.remove('hidden');
            document.getElementById('membersCard').classList.remove('hidden');
            document.getElementById('chatCard').classList.remove('hidden');

            // „É≠„Éì„Éº„Ç®„É™„Ç¢„ÇíÈö†„Åô
            document.getElementById('lobbyArea').classList.add('hidden');

            // „É°„Ç§„É≥ÁîªÈù¢„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂ§âÊõ¥
            document.getElementById('mainScreen').classList.add('in-room');
        
            // ÈÉ®Â±ãÊÉÖÂ†±„ÇíË°®Á§∫
            document.getElementById('roomTitle').textContent = currentRoom.name;
            document.getElementById('roomRule').textContent = currentRoom.rule === 'ex' ? 'EX„Çπ„Ç≥„Ç¢' : 'ÈÄöÂ∏∏„Çπ„Ç≥„Ç¢';
        
            // ÈÉ®Â±ã‰∏ª„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (currentRoom.ownerId === currentUser.userId) {
                document.getElementById('ownerControls').classList.remove('hidden');
            } else {
                document.getElementById('ownerControls').classList.add('hidden');
            }
        
            // ÂêÑ„Ç®„É™„Ç¢„ÇíÂàùÊúüÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà
            clearSongHistory();
            clearRankings();
            clearChat();
            hideConcurrentSong();

            updateRoleButtons('spectator');
        }

        function hideGameScreen() {
            document.getElementById('gameCard').classList.add('hidden');
            document.getElementById('membersCard').classList.add('hidden');
            document.getElementById('chatCard').classList.add('hidden');

            // „É≠„Éì„Éº„Ç®„É™„Ç¢„ÇíÂÜçË°®Á§∫
            document.getElementById('lobbyArea').classList.remove('hidden');

            // „É°„Ç§„É≥ÁîªÈù¢„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂÖÉ„Å´Êàª„Åô
            document.getElementById('mainScreen').classList.remove('in-room');

            // ÂêÑ„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
            clearSongHistory();
            clearRankings();
            clearChat();

            currentRoom = null;
        }

        function clearSongHistory() {
            const songHistory = document.getElementById('songHistory');
            songHistory.innerHTML = '';
            document.getElementById('songHistoryArea').classList.add('hidden');
        }

        function clearRankings() {
            const rankingsList = document.getElementById('rankingsList');
            rankingsList.innerHTML = '';
            document.getElementById('rankingsArea').classList.add('hidden');
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
        }

        function changeRole(role) {
            socket.emit('changeRole', { role });
        }

        function updateRoleButtons(role) {
            const playerBtn = document.getElementById('becomePlayerBtn');
            const spectatorBtn = document.getElementById('becomeSpectatorBtn');

            if (role === 'player') {
                playerBtn.disabled = true;
                spectatorBtn.disabled = false;
                playerBtn.textContent = '„Éó„É¨„Ç§„É§„Éº‰∏≠';
                spectatorBtn.textContent = 'Ë¶≥Êà¶ËÄÖ„Å´„Å™„Çã';
            } else {
                playerBtn.disabled = false;
                spectatorBtn.disabled = true;
                playerBtn.textContent = '„Éó„É¨„Ç§„É§„Éº„Å´„Å™„Çã';
                spectatorBtn.textContent = 'Ë¶≥Êà¶‰∏≠';
            }
        }

        function leaveRoom() {
            if (confirm('ÈÉ®Â±ã„ÇíÂá∫„Åæ„Åô„ÅãÔºü')) {
                socket.emit('leaveRoom');
                hideGameScreen();
                loadRoomList();
            }
        }

        function resetPoints() {
            if (confirm('ÂÖ®Âì°„ÅÆ„Éù„Ç§„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                socket.emit('resetPoints');
            }
        }

        function updateMembersList(members) {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';

            members.forEach(member => {
                addMemberToList(member);
            });
        }

        function addMemberToList(member) {
            const membersList = document.getElementById('membersList');
            const existingMember = document.getElementById(`member-${member.id}`);
            
            if (existingMember) {
                existingMember.remove();
            }

            const div = document.createElement('div');
            div.className = 'member-item';
            div.id = `member-${member.id}`;

            const isOwner = currentRoom && currentRoom.ownerId === member.id;
            const isCurrentUser = currentUser && currentUser.userId === member.id;

            div.innerHTML = `
                <div class="member-info">
                    ${isOwner ? '<span class="owner-crown">üëë</span>' : ''}
                    <span>${member.username}${isCurrentUser ? ' („ÅÇ„Å™„Åü)' : ''}</span>
                    <span class="player-type type-${member.type}">${member.type.toUpperCase()}</span>
                    <span class="role-badge role-${member.role}">${member.role === 'player' ? '„Éó„É¨„Ç§„É§„Éº' : 'Ë¶≥Êà¶ËÄÖ'}</span>
                </div>
                <div class="member-controls">
                    <span class="points">${member.points}pt</span>
                    ${canControlMember(member) ? `
                        <button onclick="changeMemberRole('${member.id}', '${member.role === 'player' ? 'spectator' : 'player'}')" 
                                class="btn btn-small">ÂàáÊõø</button>
                    ` : ''}
                    ${canKickMember(member) ? `
                        <button onclick="kickMember('${member.id}')" 
                                class="btn btn-danger btn-small">ËøΩÊîæ</button>
                    ` : ''}
                </div>
            `;

            membersList.appendChild(div);
        }

        function removeMemberFromList(userId) {
            const memberElement = document.getElementById(`member-${userId}`);
            if (memberElement) {
                memberElement.remove();
            }
        }

        function updateMemberRole(userId, role) {
            const memberElement = document.getElementById(`member-${userId}`);
            if (memberElement) {
                const roleBadge = memberElement.querySelector('.role-badge');
                if (roleBadge) {
                    roleBadge.className = `role-badge role-${role}`;
                    roleBadge.textContent = role === 'player' ? '„Éó„É¨„Ç§„É§„Éº' : 'Ë¶≥Êà¶ËÄÖ';
                }

                // „Éú„Çø„É≥„ÇÇÊõ¥Êñ∞
                const controlButton = memberElement.querySelector('[onclick*="changeMemberRole"]');
                if (controlButton) {
                    const newRole = role === 'player' ? 'spectator' : 'player';
                    controlButton.onclick = () => changeMemberRole(userId, newRole);
                    controlButton.textContent = 'ÂàáÊõø';
                }
            }
        }

        function canControlMember(member) {
            const canControl = currentRoom && currentRoom.ownerId === currentUser.userId && 
                   member.id !== currentUser.userId && member.type === 'api';
            
            if (currentRoom && currentRoom.ownerId === currentUser.userId) {
                console.log(`Control check for ${member.username}: type=${member.type}, canControl=${canControl}`);
            }
            
            return canControl;
        }

        function canKickMember(member) {
            return currentRoom && currentRoom.ownerId === currentUser.userId && 
                   member.id !== currentUser.userId;
        }

        function changeMemberRole(targetUserId, newRole) {
            console.log(`Attempting to change role of user ${targetUserId} to ${newRole}`);
            socket.emit('changeMemberRole', { targetUserId, role: newRole });
        }

        function kickMember(targetUserId) {
            if (confirm('„Åì„ÅÆ„É°„É≥„Éê„Éº„ÇíËøΩÊîæ„Åó„Åæ„Åô„ÅãÔºü')) {
                socket.emit('kickMember', { targetUserId });
            }
        }

        function showCurrentSong() {
            document.getElementById('currentSongArea').classList.remove('hidden');
            document.getElementById('rankingsArea').classList.remove('hidden');
        }

        function hideConcurrentSong() {
            document.getElementById('currentSongArea').classList.add('hidden');
            document.getElementById('rankingsArea').classList.add('hidden');
        }

        function updateRankings(rankings) {
            const rankingsList = document.getElementById('rankingsList');
            rankingsList.innerHTML = '';

            console.log('Updating rankings:', rankings);

            rankings.forEach((ranking, index) => {
                const div = document.createElement('div');
                div.className = 'ranking-item';

                div.innerHTML = `
                    <div class="rank rank-${ranking.rank}">#${ranking.rank}</div>
                    <div class="player-info">
                        <span>${ranking.username}</span>
                        <span class="player-type type-${ranking.type}">${ranking.type.toUpperCase()}</span>
                    </div>
                    <div class="score">${ranking.score.toLocaleString()}</div>
                `;

                rankingsList.appendChild(div);
            });

            // „É©„É≥„Ç≠„É≥„Ç∞„Ç®„É™„Ç¢„ÇíË°®Á§∫
            document.getElementById('rankingsArea').classList.remove('hidden');
            document.getElementById('currentSongArea').classList.remove('hidden');
        }

        function addSongHistory(rankings) {
            const songHistory = document.getElementById('songHistory');
            
            const div = document.createElement('div');
            div.className = 'card';
            div.style.marginBottom = '10px';
            div.style.background = '#f8f9fa';
            
            let historyHTML = '<h5>üèÅ Êõ≤ÁµÇ‰∫Ü</h5>';
            rankings.forEach((ranking, index) => {
                const points = index === 0 ? 2 : index === 1 ? 1 : 0;
                historyHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0;">
                        <span>#${ranking.rank} ${ranking.username}</span>
                        <span>${ranking.score.toLocaleString()} (+${points}pt)</span>
                    </div>
                `;
            });
            
            div.innerHTML = historyHTML;
            songHistory.insertBefore(div, songHistory.firstChild);
            
            document.getElementById('songHistoryArea').classList.remove('hidden');
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            socket.emit('sendMessage', { message });
            input.value = '';
        }

        function addChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            const div = document.createElement('div');
            div.className = 'chat-message';
            
            const time = new Date(message.timestamp).toLocaleTimeString();
            div.innerHTML = `
                <span class="chat-username">${message.username}</span>
                <span style="font-size: 12px; color: #6c757d; margin-left: 10px;">${time}</span>
                <div style="margin-top: 3px;">${message.message}</div>
            `;
            
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function checkEnvironment() {
            // URL„Éë„É©„É°„Éº„Çø„Åß„ÉÜ„Çπ„ÉàÁí∞Â¢É„ÇíÂà§ÂÆöÔºàÊú¨Êù•„ÅØÁí∞Â¢ÉÂ§âÊï∞„Çí‰ΩøÁî®Ôºâ
            const isProduction = !window.location.hostname.includes('localhost') && 
                                !window.location.hostname.includes('127.0.0.1') &&
                                !window.location.search.includes('test=1');
            
            if (!isProduction) {
                document.getElementById('testArea').classList.remove('hidden');
            }
        }

        function sendTestScore() {
            const normalScore = parseInt(document.getElementById('testNormalScore').value) || 0;
            const exScore = parseInt(document.getElementById('testExScore').value) || 0;
            
            if (normalScore === 0 && exScore === 0) {
                alert('„Çπ„Ç≥„Ç¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            socket.emit('sendTestScore', { normalScore, exScore });
            
            // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
            document.getElementById('testNormalScore').value = '';
            document.getElementById('testExScore').value = '';
        }

        function finishTestSong() {
            socket.emit('finishTestSong');
        }

        function openDuelVisualizer() {
            if (currentRoom) {
                const url = `/duel.html?room=${currentRoom.id}`;
                window.open(url, '_blank', 'width=1200,height=800');
            }
        }

        function openMultiVisualizer() {
            if (currentRoom) {
                const url = `/multi.html?room=${currentRoom.id}`;
                window.open(url, '_blank', 'width=1200,height=600');
            }
        }
    </script>
</body>
</html>