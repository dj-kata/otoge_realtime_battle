<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2‰∫∫ÂØæÊà¶„Éì„É•„Éº - Rhythm Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 5px;
            padding: 10px;
            line-height: 150%;
            overflow: hidden;
            font-family: "RocknRoll One", sans-serif;
            color: #fff;
            font-size: 32px;
            text-shadow:
                1px 1px 1px #000, -1px -1px 1px #000,
                -1px 1px 1px #000, 1px -1px 1px #000,
                1px 1px 1px #000, -1px -1px 1px #000,
                1px 1px 1px #000, 1px -1px 1px #000;
            margin: 0;
        }

        #base{
            background-color: #222;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .room-info {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .status {
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .player1 {
            color: #ffaaaa;
            font-size: 48px;
            font-weight: 400;
        }

        .player2 {
            color: #aaaaff;
            font-size: 48px;
            font-weight: 400;
        }

        .score {
            color: #ffffff;
            font-size: 36px;
        }

        .diff {
            color: #ffffff;
            font-size: 32px;
            padding-top: 10px;
        }

        .lead {
            color: #ffffff;
            font-size: 44px;
        }

        win {
            color: #ffff00;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        lose {
            color: #cccccc;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
        }

        even {
            color: #ffffff;
        }

        table {
            width: 100%;
            table-layout: fixed;
        }

        td {
            text-align: center;
            vertical-align: middle;
        }

        #chart_div {
            width: 100%;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 768px) {
            .player1, .player2 {
                font-size: 32px;
            }
            
            .score {
                font-size: 24px;
            }
            
            .diff {
                font-size: 24px;
            }
            
            .lead {
                font-size: 32px;
            }
            
            body {
                font-size: 24px;
            }
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let socket;
        let currentRoom = null;
        let playerOrder = []; // ÂÖ•ÂÆ§È†Ü„ÇíË®òÈå≤
        
        // Google ChartsÂ§âÊï∞
        var data;
        var chart;
        var options;

        // Google ChartsÂàùÊúüÂåñ
        google.charts.load('current', { 'packages': ['corechart', 'bar'], 'language': 'ja' });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
            data = google.visualization.arrayToDataTable([
                ['nouse', 'p1', 'p2'],
                ['', 1000, 1000], // ÂàùÊúüÂÄ§„Çí1000„Å´Ë®≠ÂÆö
            ]);
            
            options = {
                chartArea: { left: 50, right: 50, top: 20, bottom: 20, width: '80%', height: 80 },
                width: '100%',
                height: 120,
                legend: { position: 'none' },
                bar: { groupWidth: '60%' },
                isStacked: true,
                backgroundColor: 'transparent',
                series: {
                    0: { color: '#DD4445' }, // Player1„ÅÆËâ≤ÔºàËµ§Ôºâ
                    1: { color: '#4444dd' }, // Player2„ÅÆËâ≤ÔºàÈùíÔºâ
                },
                hAxis: {
                    textStyle: { fontSize: 0, color: 'transparent' },
                    gridlines: { color: 'transparent' },
                    minValue: 0,
                    maxValue: 2000,
                    ticks: [],
                    baselineColor: 'transparent'
                },
                vAxis: {
                    textStyle: { fontSize: 0, color: 'transparent' },
                    gridlines: { color: 'transparent' },
                    baselineColor: 'transparent'
                },
            };
            
            chart = new google.visualization.BarChart(document.getElementById('chart_div'));
            chart.draw(data, options);
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');

            if (!roomId) {
                document.querySelector('.status').innerHTML = '‚ùå ÈÉ®Â±ãID„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
                return;
            }

            socket = io();
            setupEventListeners();
            connectToRoom(roomId);
        });

        function setupEventListeners() {
            socket.on('connect', () => {
                console.log('Connected to server');
            });

            socket.on('roomInfo', (room) => {
                currentRoom = room;
                updateRoomInfo(room);
                console.log('Room info received:', room);
            });

            socket.on('rankingsUpdated', (rankings) => {
                console.log('Rankings updated:', rankings);
                updateDisplay(rankings);
            });

            socket.on('scoreUpdated', (data) => {
                console.log('Score updated:', data);
            });

            socket.on('songFinished', (data) => {
                console.log('Song finished:', data);
                if (data.rankings) {
                    updateDisplay(data.rankings);
                }
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data);
                document.querySelector('.status').innerHTML = `‚ùå „Ç®„É©„Éº: ${data.message}`;
            });

            socket.on('disconnect', () => {
                document.querySelector('.status').innerHTML = '‚ùå „Çµ„Éº„Éê„Éº„Å®„ÅÆÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü';
            });
        }

        function connectToRoom(roomId) {
            document.querySelector('.status').innerHTML = 'üîÑ ÈÉ®Â±ã„Å´Êé•Á∂ö‰∏≠...';
            
            playerOrder = [];
            console.log('Player order reset');
            
            fetch(`/api/rooms`)
                .then(response => response.json())
                .then(rooms => {
                    const room = rooms.find(r => r.id === roomId);
                    if (room) {
                        currentRoom = room;
                        updateRoomInfo(room);
                        
                        socket.emit('watchRoom', { roomId });
                        document.querySelector('.status').innerHTML = '‚úÖ ÈÉ®Â±ã„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü - „Çπ„Ç≥„Ç¢ÂæÖ„Å°';
                        
                        console.log('Connected to room:', room);
                    } else {
                        document.querySelector('.status').innerHTML = '‚ùå ÊåáÂÆö„Åï„Çå„ÅüÈÉ®Â±ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                    }
                })
                .catch(error => {
                    console.error('Error fetching room info:', error);
                    document.querySelector('.status').innerHTML = '‚ùå ÈÉ®Â±ãÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                });
        }

        function updateRoomInfo(room) {
            document.querySelector('.room-info').innerHTML = `
                <strong>${room.name}</strong> (${room.rule === 'ex' ? 'EX„Çπ„Ç≥„Ç¢' : 'ÈÄöÂ∏∏„Çπ„Ç≥„Ç¢'})
            `;
        }

        function updateDisplay(rankings) {
            // API„É¶„Éº„Ç∂„Éº„ÅÆ„Åø„ÇíÂØæË±°„Å´„Éï„Ç£„É´„Çø
            const apiPlayers = rankings.filter(r => r.type === 'api' && r.username !== 'Unknown');
            
            console.log('Updating display with players:', apiPlayers);
            
            // ÂÖ•ÂÆ§È†Ü„ÇíË®òÈå≤„ÉªÁ∂≠ÊåÅ
            apiPlayers.forEach(player => {
                if (!playerOrder.find(p => p.userId === player.userId)) {
                    playerOrder.push({
                        userId: player.userId,
                        username: player.username,
                        joinOrder: playerOrder.length
                    });
                    console.log(`Added player to order: ${player.username} (position ${playerOrder.length - 1})`);
                }
            });

            // ÂÖ•ÂÆ§È†Ü„Åß„ÇΩ„Éº„Éà„Åó„ÄÅÊúÄÂàù„ÅÆ2‰∫∫„ÇíÂèñÂæó
            const orderedPlayers = apiPlayers
                .map(player => {
                    const orderInfo = playerOrder.find(p => p.userId === player.userId);
                    return {
                        ...player,
                        joinOrder: orderInfo ? orderInfo.joinOrder : 999
                    };
                })
                .sort((a, b) => a.joinOrder - b.joinOrder)
                .slice(0, 2);

            console.log('Ordered players:', orderedPlayers);

            let p1 = 'ÂæÖÊ©ü‰∏≠';
            let p2 = 'ÂæÖÊ©ü‰∏≠';
            let sc1 = 0;
            let sc2 = 0;

            if (orderedPlayers.length >= 1) {
                p1 = orderedPlayers[0].username;
                sc1 = orderedPlayers[0].score;
            }

            if (orderedPlayers.length >= 2) {
                p2 = orderedPlayers[1].username;
                sc2 = orderedPlayers[1].score;
            }

            // „Éó„É¨„Ç§„É§„ÉºÂêç„ÇíÊõ¥Êñ∞
            $('p1').text(p1);
            $('p2').text(p2);

            // „Çπ„Ç≥„Ç¢Â∑Æ„Å®„Éê„Éº„ÅÆË®àÁÆó
            var v1 = 0;
            var v2 = 0;
            var diff = 0;
            var MAXVAL = 100000; // ÊúÄÂ§ß„ÅÆÁÇπÂ∑Æ
            var sc1_use = sc1;
            var sc2_use = sc2;

            if (currentRoom && currentRoom.rule === 'ex') {
                // EX„Çπ„Ç≥„Ç¢„É¢„Éº„Éâ
                MAXVAL = 200;
                let diff_mod = Math.max(-MAXVAL, Math.min(sc1 - sc2, MAXVAL));
                let diff_st = diff_mod * 4.95;
                v1 = 1000 + diff_st;
                v2 = 1000 - diff_st;
                diff = Math.abs(Math.floor(sc1 - sc2));
            } else {
                // ÈÄöÂ∏∏„Çπ„Ç≥„Ç¢„É¢„Éº„Éâ
                MAXVAL = 100000;
                let diff_mod = Math.max(-MAXVAL, Math.min(sc1 - sc2, MAXVAL));
                let diff_st = diff_mod / 101.0101;
                v1 = 1000 + diff_st;
                v2 = 1000 - diff_st;
                diff = Math.abs(Math.floor((sc1 - sc2) / 1000));
                if (diff != 0) {
                    diff = diff + 'k';
                }
            }

            // „Çπ„Ç≥„Ç¢Ë°®Á§∫„ÅÆÊõ¥Êñ∞
            var sc1_str = sc1_use.toLocaleString();
            var sc2_str = sc2_use.toLocaleString();

            if (sc1_use > sc2_use) {
                sc1_str = "<win>" + sc1_str + "</win>";
                sc2_str = "<lose>" + sc2_str + "</lose>";
                $('lead1').text("‚óÄ");
                $('lead2').text("");
            } else if (sc2_use > sc1_use) {
                sc1_str = "<lose>" + sc1_str + "</lose>";
                sc2_str = "<win>" + sc2_str + "</win>";
                $('lead1').text("");
                $('lead2').text("‚ñ∂");
            } else {
                sc1_str = "<even>" + sc1_str + "</even>";
                sc2_str = "<even>" + sc2_str + "</even>";
                $('lead1').text("");
                $('lead2').text("");
            }

            $('sc1').html(sc1_str);
            $('sc2').html(sc2_str);
            $('diff').html(diff);

            console.log(`Score calculation: sc1=${sc1}, sc2=${sc2}, diff=${diff}, v1=${v1}, v2=${v2}`);

            // Google Charts„ÅÆ„Éê„Éº„ÇíÊõ¥Êñ∞
            console.log(`Updating chart: v1=${v1}, v2=${v2}`);
            if (data && chart) {
                data.setValue(0, 1, Math.max(0, v1));
                data.setValue(0, 2, Math.max(0, v2));
                chart.draw(data, options);
            }
        }
    </script>
</head>
<body>

    <div id="base">
        <table width="100%">
            <tr align="center">
                <td width="35%" class="player1"><p1>ÂæÖÊ©ü‰∏≠</p1></td>
                <td width="15%"></td>
                <td width="15%"></td>
                <td width="35%" class="player2"><p2>ÂæÖÊ©ü‰∏≠</p2></td>
            </tr>
            <tr align="center">
                <td width="35%" class="score"><sc1>0</sc1></td>
                <td width="15%" class="lead"><lead1></lead1></td>
                <td width="15%" class="lead"><lead2></lead2></td>
                <td width="35%" class="score"><sc2>0</sc2></td>
            </tr>
            <tr align="center">
                <td colspan="4" class="diff"><diff>0</diff></td>
            </tr>
        </table>
        <div id="chart_div"></div>
    </div>
    <div class="header">
        <div class="room-info">ÈÉ®Â±ã„Å´Êé•Á∂ö‰∏≠...</div>
        <div class="status">Êé•Á∂öÂæÖÊ©ü‰∏≠...</div>
    </div>
</body>
</html>