<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDVX Helper Realtime Battle</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .hidden {
            display: none !important;
        }

        /* ログイン画面 */
        .login-screen {
            max-width: 400px;
            margin: 50px auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* メイン画面 */
        .main-screen {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .main-screen.in-room {
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 1024px) {
            .main-screen {
                grid-template-columns: 1fr;
            }
        }

        /* 部屋一覧・作成 */
        .room-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .room-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .room-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .room-content {
            margin-right: 60px; /* 削除ボタンのスペースを確保 */
        }

        .room-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .room-info {
            font-size: 14px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
        }

        .room-rule {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .room-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .room-delete-btn:hover {
            opacity: 1;
        }

        /* ゲーム画面 */
        .game-area {
            text-align: center;
        }

        .current-song {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rankings {
            margin-bottom: 20px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .rank {
            font-weight: bold;
            font-size: 20px;
            width: 40px;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .type-api { background: #007bff; color: white; }
        .type-web { background: #6c757d; color: white; }

        .score {
            font-weight: 600;
            font-size: 18px;
        }

        /* メンバーリスト */
        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            min-height: 60px;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .member-info span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        .owner-crown {
            color: #ffd700;
            font-weight: bold;
            flex-shrink: 0;
        }

        .role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .role-player { background: #28a745; color: white; }
        .role-spectator { background: #6c757d; color: white; }

        .points {
            font-weight: 600;
            color: #667eea;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* チャット */
        .chat-container {
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            background: #f8f9fa;
            margin-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .chat-username {
            font-weight: 600;
            color: #667eea;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
        }

        /* テストエリア */
        .test-area {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .test-area h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        /* モーダル */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }

        /* ユーティリティ */
        .flex {
            display: flex;
        }

        .flex-between {
            justify-content: space-between;
        }

        .flex-center {
            align-items: center;
        }

        .gap-10 {
            gap: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .text-center {
            text-align: center;
        }

        .full-width {
            width: 100%;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .main-screen {
                grid-template-columns: 1fr;
            }

            .room-content {
                margin-right: 50px;
            }

            .room-delete-btn {
                padding: 3px 6px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SDVX Helper Realtime Battle</h1>
            <p>アリーナ風の対戦に使えるかも？BPL風の2人対戦ビューと複数人のランキング形式ビューを搭載。</p>
        </div>

        <!-- ログイン画面 -->
        <div id="loginScreen" class="login-screen">
            <div class="card">
                <h2 class="text-center mb-20">システムに接続</h2>
                <div class="input-group">
                    <label for="usernameInput">ユーザー名</label>
                    <input type="text" id="usernameInput" placeholder="ユーザー名を入力" maxlength="20">
                </div>
                <button id="connectBtn" class="btn full-width">接続</button>
            </div>
        </div>

        <!-- メイン画面 -->
        <div id="mainScreen" class="main-screen hidden">
            <!-- 左側: 部屋一覧・作成 -->
            <div id="lobbyArea" class="sidebar">
                <div class="card">
                    <h3 class="mb-20">部屋を作成</h3>
                    <div class="input-group">
                        <label for="roomNameInput">部屋名</label>
                        <input type="text" id="roomNameInput" placeholder="部屋名" maxlength="30">
                    </div>
                    <div class="input-group">
                        <label for="ruleSelect">ルール</label>
                        <select id="ruleSelect">
                            <option value="normal">通常スコア</option>
                            <option value="ex">EXスコア</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="passwordInput">パスワード（任意）</label>
                        <input type="text" id="passwordInput" placeholder="パスワード" maxlength="20">
                    </div>
                    <button id="createRoomBtn" class="btn full-width">部屋を作成</button>
                </div>

                <div class="card">
                    <div class="flex flex-between flex-center mb-20">
                        <h3>部屋一覧</h3>
                        <button id="refreshRoomsBtn" class="btn btn-small">更新</button>
                    </div>
                    <div id="roomList" class="room-list">
                        <!-- 部屋一覧がここに表示される -->
                    </div>
                </div>
            </div>

            <!-- 中央: ゲーム画面 -->
            <div class="game-area">
                <div id="gameCard" class="card hidden">
                    <div class="flex flex-between flex-center mb-20">
                        <h2 id="roomTitle">部屋名</h2>
                        <div>
                            <span id="roomRule" class="room-rule">通常スコア</span>
                        </div>
                    </div>

                    <div id="currentSongArea" class="hidden">
                        <div class="current-song">
                            <h3>🎵 現在プレイ中</h3>
                            <p>プレイヤーのスコア待ち...</p>
                        </div>
                    </div>

                    <div id="rankingsArea" class="rankings hidden">
                        <h3 class="mb-10">🏆 現在のランキング</h3>
                        <div id="rankingsList">
                            <!-- ランキングがここに表示される -->
                        </div>
                    </div>

                    <div id="songHistoryArea" class="hidden">
                        <h3 class="mb-10">📚 過去の結果</h3>
                        <div id="songHistory">
                            <!-- 過去の結果がここに表示される -->
                        </div>
                    </div>

                    <!-- ロール切り替えボタン -->
                    <div class="flex gap-10 mb-20">
                        <button id="becomePlayerBtn" class="btn">プレイヤーになる</button>
                        <button id="becomeSpectatorBtn" class="btn btn-secondary">観戦者になる</button>
                    </div>

                    <!-- 可視化ビュー（全員表示） -->
                    <div class="flex gap-10 mb-20">
                        <button id="openDuelVisualizerBtn" class="btn btn-small">2人対戦ビュー</button>
                        <button id="openMultiVisualizerBtn" class="btn btn-small">多人数ビュー</button>
                    </div>

                    <!-- 部屋主専用エリア -->
                    <div id="ownerControls" class="hidden">
                        <h4 class="mb-10">👑 部屋主メニュー</h4>
                        <div class="flex gap-10 mb-10">
                            <button id="resetPointsBtn" class="btn btn-secondary btn-small">ポイントリセット</button>
                        </div>
                    </div>

                    <button id="leaveRoomBtn" class="btn btn-secondary full-width">部屋を出る</button>

                    <!-- テストエリア (開発環境のみ) -->
                    <div id="testArea" class="test-area hidden">
                        <h3>🧪 テスト機能</h3>
                        <p class="mb-10">開発環境でのみ利用可能です</p>
                        <div class="flex gap-10 mb-10">
                            <input type="number" id="testNormalScore" placeholder="通常スコア" style="flex: 1;">
                            <input type="number" id="testExScore" placeholder="EXスコア" style="flex: 1;">
                        </div>
                        <div class="flex gap-10">
                            <button id="sendTestScoreBtn" class="btn btn-small">スコア送信</button>
                            <button id="finishTestSongBtn" class="btn btn-small">曲終了</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側: メンバー・チャット -->
            <div class="sidebar">
                <div id="membersCard" class="card hidden">
                    <h3 class="mb-20">👥 メンバー一覧</h3>
                    <div id="membersList">
                        <!-- メンバーがここに表示される -->
                    </div>
                </div>

                <div id="chatCard" class="card hidden">
                    <h3 class="mb-10">💬 チャット</h3>
                    <div class="chat-container">
                        <div id="chatMessages" class="chat-messages">
                            <!-- チャットメッセージがここに表示される -->
                        </div>
                        <div class="chat-input-container">
                            <input type="text" id="chatInput" class="chat-input" placeholder="メッセージを入力..." maxlength="200">
                            <button id="sendChatBtn" class="btn">送信</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- パスワード入力モーダル -->
    <div id="passwordModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-center mb-20">パスワードが必要です</h3>
            <div class="input-group">
                <label for="joinPasswordInput">パスワード</label>
                <input type="password" id="joinPasswordInput" placeholder="パスワードを入力">
            </div>
            <div class="flex gap-10">
                <button id="cancelJoinBtn" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
                <button id="confirmJoinBtn" class="btn" style="flex: 1;">入室</button>
            </div>
        </div>
    </div>

    <!-- 管理者削除モーダル -->
    <div id="adminDeleteModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-center mb-20">🛡️ 管理者権限が必要です</h3>
            <p class="text-center mb-20" style="color: #6c757d;">この部屋を削除するには管理者パスワードが必要です</p>
            <div class="mb-10">
                <strong>削除対象：</strong><span id="deleteTargetRoomName"></span>
            </div>
            <div class="input-group">
                <label for="adminPasswordInput">管理者パスワード</label>
                <input type="password" id="adminPasswordInput" placeholder="管理者パスワードを入力">
            </div>
            <div class="flex gap-10">
                <button id="cancelAdminDeleteBtn" class="btn btn-secondary" style="flex: 1;">キャンセル</button>
                <button id="confirmAdminDeleteBtn" class="btn btn-danger" style="flex: 1;">削除実行</button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let socket;
        let currentUser = null;
        let currentRoom = null;
        let joinRoomId = null;
        let deleteTargetRoomId = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            socket = io();
            setupEventListeners();
            loadRoomList();

            // 開発環境かチェック
            checkEnvironment();
        });

        function setupEventListeners() {
            // ログイン
            document.getElementById('connectBtn').addEventListener('click', connect);
            document.getElementById('usernameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') connect();
            });

            // 部屋作成
            document.getElementById('createRoomBtn').addEventListener('click', createRoom);

            // 部屋更新
            document.getElementById('refreshRoomsBtn').addEventListener('click', loadRoomList);

            // ロール変更
            document.getElementById('becomePlayerBtn').addEventListener('click', () => changeRole('player'));
            document.getElementById('becomeSpectatorBtn').addEventListener('click', () => changeRole('spectator'));

            // 部屋退出
            document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);

            // 部屋主機能
            document.getElementById('resetPointsBtn').addEventListener('click', resetPoints);
            
            // 可視化ビュー（全員）
            document.getElementById('openDuelVisualizerBtn').addEventListener('click', openDuelVisualizer);
            document.getElementById('openMultiVisualizerBtn').addEventListener('click', openMultiVisualizer);

            // チャット
            document.getElementById('sendChatBtn').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // パスワードモーダル
            document.getElementById('cancelJoinBtn').addEventListener('click', hidePasswordModal);
            document.getElementById('confirmJoinBtn').addEventListener('click', joinRoomWithPassword);
            document.getElementById('joinPasswordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoomWithPassword();
            });

            // 管理者削除モーダル
            document.getElementById('cancelAdminDeleteBtn').addEventListener('click', hideAdminDeleteModal);
            document.getElementById('confirmAdminDeleteBtn').addEventListener('click', executeAdminDelete);
            document.getElementById('adminPasswordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') executeAdminDelete();
            });

            // テスト機能
            document.getElementById('sendTestScoreBtn').addEventListener('click', sendTestScore);
            document.getElementById('finishTestSongBtn').addEventListener('click', finishTestSong);
        }

        function setupSocketListeners() {
            socket.on('connected', (data) => {
                currentUser = data;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                loadRoomList();
            });

            socket.on('roomCreated', (data) => {
                loadRoomList();
            });

            socket.on('roomListUpdated', () => {
                loadRoomList();
            });

            socket.on('joinedRoom', (data) => {
                currentRoom = data.room;
                showGameScreen();
                updateMembersList(data.members);
                
                // 過去の履歴をクリアしてから新しい部屋の履歴を表示
                clearSongHistory();
                if (data.songHistory && data.songHistory.length > 0) {
                    data.songHistory.forEach(song => {
                        const rankings = song.calculateRankings ? song.calculateRankings(data.room.rule) : song.rankings;
                        if (rankings) {
                            addSongHistory(rankings);
                        }
                    });
                    document.getElementById('songHistoryArea').classList.remove('hidden');
                }
                
                if (data.currentSong) {
                    showCurrentSong();
                }
                
                // 自分のロールをボタンに反映
                const currentMember = data.members.find(m => m.id === currentUser.userId);
                if (currentMember) {
                    updateRoleButtons(currentMember.role);
                    console.log(`Joined room as ${currentMember.role}`);
                }
            });

            socket.on('memberJoined', (member) => {
                console.log('Member joined:', member);
                addMemberToList(member);
            });

            socket.on('memberLeft', (data) => {
                console.log('Member left:', data);
                removeMemberFromList(data.userId);
            });

            socket.on('memberKicked', (data) => {
                removeMemberFromList(data.userId);
                if (data.userId === currentUser.userId) {
                    alert('部屋から退出させられました');
                    hideGameScreen();
                }
            });

            socket.on('roleChanged', (data) => {
                updateMemberRole(data.userId, data.role);
                if (data.userId === currentUser.userId) {
                    updateRoleButtons(data.role);
                }
                console.log(`Role changed: ${data.username} is now ${data.role}`);
            });

            socket.on('scoreUpdated', (data) => {
                console.log('Score updated:', data);
            });

            socket.on('rankingsUpdated', (rankings) => {
                updateRankings(rankings);
            });

            socket.on('userFinished', (data) => {
                console.log('User finished:', data);
            });

            socket.on('songFinished', (data) => {
                hideConcurrentSong();
                updateMembersList(data.members);
                addSongHistory(data.rankings);
            });

            socket.on('pointsReset', (data) => {
                updateMembersList(data.members);
                alert('ポイントがリセットされました');
            });

            socket.on('roomDeleted', () => {
                alert('部屋が削除されました');
                hideGameScreen();
                loadRoomList();
            });

            socket.on('newMessage', (message) => {
                addChatMessage(message);
            });

            socket.on('kicked', () => {
                alert('部屋から退出させられました');
                hideGameScreen();
            });

            socket.on('error', (data) => {
                alert('エラー: ' + data.message);
            });
        }

        function connect() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('ユーザー名を入力してください');
                return;
            }

            setupSocketListeners();
            socket.emit('webConnect', { username });
        }

        function createRoom() {
            const name = document.getElementById('roomNameInput').value.trim();
            const rule = document.getElementById('ruleSelect').value;
            const password = document.getElementById('passwordInput').value.trim() || null;

            if (!name) {
                alert('部屋名を入力してください');
                return;
            }

            socket.emit('createRoom', { name, rule, password });

            // フォームをクリア
            document.getElementById('roomNameInput').value = '';
            document.getElementById('passwordInput').value = '';
        }

        function loadRoomList() {
            fetch('/api/rooms')
                .then(response => response.json())
                .then(rooms => {
                    const roomList = document.getElementById('roomList');
                    roomList.innerHTML = '';

                    if (rooms.length === 0) {
                        roomList.innerHTML = '<p style="text-align: center; color: #6c757d;">部屋がありません</p>';
                        return;
                    }

                    rooms.forEach(room => {
                        const roomElement = createRoomElement(room);
                        roomList.appendChild(roomElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading rooms:', error);
                });
        }

        function createRoomElement(room) {
            const div = document.createElement('div');
            div.className = 'room-item';
            
            // 部屋の内容部分をクリックで入室
            div.onclick = (e) => {
                // 削除ボタンがクリックされた場合は入室処理をスキップ
                if (e.target.classList.contains('room-delete-btn')) {
                    return;
                }
                joinRoom(room.id, room.hasPassword);
            };

            div.innerHTML = `
                <div class="room-content">
                    <div class="room-name">${room.name}</div>
                    <div class="room-info">
                        <span class="room-rule">${room.rule === 'ex' ? 'EXスコア' : '通常スコア'}</span>
                        <span>${room.memberCount}人 ${room.hasPassword ? '🔒' : ''}</span>
                    </div>
                </div>
                <button class="room-delete-btn" onclick="showAdminDeleteModal('${room.id}', '${room.name}')" title="管理者削除">🗑️</button>
            `;

            return div;
        }

        function joinRoom(roomId, hasPassword) {
            joinRoomId = roomId;

            if (hasPassword) {
                showPasswordModal();
            } else {
                socket.emit('joinRoom', { roomId, password: null });
            }
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('joinPasswordInput').focus();
        }

        function hidePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('joinPasswordInput').value = '';
            joinRoomId = null;
        }

        function joinRoomWithPassword() {
            const password = document.getElementById('joinPasswordInput').value;
            socket.emit('joinRoom', { roomId: joinRoomId, password });
            hidePasswordModal();
        }

        function showAdminDeleteModal(roomId, roomName) {
            deleteTargetRoomId = roomId;
            document.getElementById('deleteTargetRoomName').textContent = roomName;
            document.getElementById('adminDeleteModal').classList.remove('hidden');
            document.getElementById('adminPasswordInput').focus();
        }

        function hideAdminDeleteModal() {
            document.getElementById('adminDeleteModal').classList.add('hidden');
            document.getElementById('adminPasswordInput').value = '';
            deleteTargetRoomId = null;
        }

        function executeAdminDelete() {
            const adminPassword = document.getElementById('adminPasswordInput').value;
            
            if (!adminPassword) {
                alert('管理者パスワードを入力してください');
                return;
            }

            if (!deleteTargetRoomId) {
                alert('削除対象の部屋が見つかりません');
                hideAdminDeleteModal();
                return;
            }

            const roomName = document.getElementById('deleteTargetRoomName').textContent;
            
            // 確認ダイアログ
            if (!confirm(`部屋「${roomName}」を削除しますか？\nこの操作は取り消せません。`)) {
                return;
            }

            // 管理者削除API呼び出し
            fetch(`/api/admin/rooms/${deleteTargetRoomId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    adminPassword: adminPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('部屋が削除されました');
                    hideAdminDeleteModal();
                    loadRoomList(); // 部屋一覧を更新
                } else {
                    alert('エラー: ' + (data.error || '削除に失敗しました'));
                }
            })
            .catch(error => {
                console.error('Admin delete error:', error);
                alert('部屋の削除中にエラーが発生しました');
            });
        }

        function showGameScreen() {
            document.getElementById('gameCard').classList.remove('hidden');
            document.getElementById('membersCard').classList.remove('hidden');
            document.getElementById('chatCard').classList.remove('hidden');
            
            // ロビーエリアを隠す
            document.getElementById('lobbyArea').classList.add('hidden');
            
            // メイン画面のレイアウトを変更
            document.getElementById('mainScreen').classList.add('in-room');

            // 部屋情報を表示
            document.getElementById('roomTitle').textContent = currentRoom.name;
            document.getElementById('roomRule').textContent = currentRoom.rule === 'ex' ? 'EXスコア' : '通常スコア';

            // 部屋主かどうかをチェック（ポイントリセットのみ表示）
            if (currentRoom.ownerId === currentUser.userId) {
                document.getElementById('ownerControls').classList.remove('hidden');
            } else {
                document.getElementById('ownerControls').classList.add('hidden');
            }

            // 各エリアを初期状態にリセット
            clearSongHistory();
            clearRankings();
            clearChat();
            hideConcurrentSong();
            
            updateRoleButtons('spectator');
        }

        function hideGameScreen() {
            document.getElementById('gameCard').classList.add('hidden');
            document.getElementById('membersCard').classList.add('hidden');
            document.getElementById('chatCard').classList.add('hidden');
            
            // ロビーエリアを再表示
            document.getElementById('lobbyArea').classList.remove('hidden');
            
            // メイン画面のレイアウトを元に戻す
            document.getElementById('mainScreen').classList.remove('in-room');
            
            // 各エリアをクリア
            clearSongHistory();
            clearRankings();
            clearChat();
            
            currentRoom = null;
        }

        // 新しいヘルパー関数を追加
        function clearSongHistory() {
            const songHistory = document.getElementById('songHistory');
            songHistory.innerHTML = '';
            document.getElementById('songHistoryArea').classList.add('hidden');
        }

        function clearRankings() {
            const rankingsList = document.getElementById('rankingsList');
            rankingsList.innerHTML = '';
            document.getElementById('rankingsArea').classList.add('hidden');
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
        }

        function changeRole(role) {
            socket.emit('changeRole', { role });
        }

        function updateRoleButtons(role) {
            const playerBtn = document.getElementById('becomePlayerBtn');
            const spectatorBtn = document.getElementById('becomeSpectatorBtn');

            if (role === 'player') {
                playerBtn.disabled = true;
                spectatorBtn.disabled = false;
                playerBtn.textContent = 'プレイヤー中';
                spectatorBtn.textContent = '観戦者になる';
            } else {
                playerBtn.disabled = false;
                spectatorBtn.disabled = true;
                playerBtn.textContent = 'プレイヤーになる';
                spectatorBtn.textContent = '観戦中';
            }
        }

        function leaveRoom() {
            if (confirm('部屋を出ますか？')) {
                socket.emit('leaveRoom');
                hideGameScreen();
                loadRoomList();
            }
        }

        function resetPoints() {
            if (confirm('全員のポイントをリセットしますか？')) {
                socket.emit('resetPoints');
            }
        }

        function updateMembersList(members) {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';

            members.forEach(member => {
                addMemberToList(member);
            });
        }

        function addMemberToList(member) {
            const membersList = document.getElementById('membersList');
            const existingMember = document.getElementById(`member-${member.id}`);
            
            if (existingMember) {
                existingMember.remove();
            }

            const div = document.createElement('div');
            div.className = 'member-item';
            div.id = `member-${member.id}`;

            const isOwner = currentRoom && currentRoom.ownerId === member.id;
            const isCurrentUser = currentUser && currentUser.userId === member.id;

            div.innerHTML = `
                <div class="member-info">
                    ${isOwner ? '<span class="owner-crown">👑</span>' : ''}
                    <span>${member.username}${isCurrentUser ? ' (あなた)' : ''}</span>
                    <span class="player-type type-${member.type}">${member.type.toUpperCase()}</span>
                    <span class="role-badge role-${member.role}">${member.role === 'player' ? 'プレイヤー' : '観戦者'}</span>
                </div>
                <div class="member-controls">
                    <span class="points">${member.points}pt</span>
                    ${canControlMember(member) ? `
                        <button onclick="changeMemberRole('${member.id}', '${member.role === 'player' ? 'spectator' : 'player'}')" 
                                class="btn btn-small">切替</button>
                    ` : ''}
                    ${canKickMember(member) ? `
                        <button onclick="kickMember('${member.id}')" 
                                class="btn btn-danger btn-small">追放</button>
                    ` : ''}
                </div>
            `;

            membersList.appendChild(div);
        }

        function removeMemberFromList(userId) {
            const memberElement = document.getElementById(`member-${userId}`);
            if (memberElement) {
                memberElement.remove();
            }
        }

        function updateMemberRole(userId, role) {
            const memberElement = document.getElementById(`member-${userId}`);
            if (memberElement) {
                const roleBadge = memberElement.querySelector('.role-badge');
                if (roleBadge) {
                    roleBadge.className = `role-badge role-${role}`;
                    roleBadge.textContent = role === 'player' ? 'プレイヤー' : '観戦者';
                }

                // ボタンも更新
                const controlButton = memberElement.querySelector('[onclick*="changeMemberRole"]');
                if (controlButton) {
                    const newRole = role === 'player' ? 'spectator' : 'player';
                    controlButton.onclick = () => changeMemberRole(userId, newRole);
                    controlButton.textContent = '切替';
                }
            }
        }

        function canControlMember(member) {
            const canControl = currentRoom && currentRoom.ownerId === currentUser.userId && 
                   member.id !== currentUser.userId && member.type === 'api';
            
            if (currentRoom && currentRoom.ownerId === currentUser.userId) {
                console.log(`Control check for ${member.username}: type=${member.type}, canControl=${canControl}`);
            }
            
            return canControl;
        }

        function canKickMember(member) {
            return currentRoom && currentRoom.ownerId === currentUser.userId && 
                   member.id !== currentUser.userId;
        }

        function changeMemberRole(targetUserId, newRole) {
            console.log(`Attempting to change role of user ${targetUserId} to ${newRole}`);
            socket.emit('changeMemberRole', { targetUserId, role: newRole });
        }

        function kickMember(targetUserId) {
            if (confirm('このメンバーを追放しますか？')) {
                socket.emit('kickMember', { targetUserId });
            }
        }

        function showCurrentSong() {
            document.getElementById('currentSongArea').classList.remove('hidden');
            document.getElementById('rankingsArea').classList.remove('hidden');
        }

        function hideConcurrentSong() {
            document.getElementById('currentSongArea').classList.add('hidden');
            document.getElementById('rankingsArea').classList.add('hidden');
        }

        function updateRankings(rankings) {
            const rankingsList = document.getElementById('rankingsList');
            rankingsList.innerHTML = '';

            console.log('Updating rankings:', rankings);

            rankings.forEach((ranking, index) => {
                const div = document.createElement('div');
                div.className = 'ranking-item';

                div.innerHTML = `
                    <div class="rank rank-${ranking.rank}">#${ranking.rank}</div>
                    <div class="player-info">
                        <span>${ranking.username}</span>
                        <span class="player-type type-${ranking.type}">${ranking.type.toUpperCase()}</span>
                    </div>
                    <div class="score">${ranking.score.toLocaleString()}</div>
                `;

                rankingsList.appendChild(div);
            });

            // ランキングエリアを表示
            document.getElementById('rankingsArea').classList.remove('hidden');
            document.getElementById('currentSongArea').classList.remove('hidden');
        }

        function addSongHistory(rankings) {
            const songHistory = document.getElementById('songHistory');
            
            const div = document.createElement('div');
            div.className = 'card';
            div.style.marginBottom = '10px';
            div.style.background = '#f8f9fa';
            
            let historyHTML = '<h5>🏁 曲終了</h5>';
            rankings.forEach((ranking, index) => {
                const points = index === 0 ? 2 : index === 1 ? 1 : 0;
                historyHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0;">
                        <span>#${ranking.rank} ${ranking.username}</span>
                        <span>${ranking.score.toLocaleString()} (+${points}pt)</span>
                    </div>
                `;
            });
            
            div.innerHTML = historyHTML;
            songHistory.insertBefore(div, songHistory.firstChild);
            
            document.getElementById('songHistoryArea').classList.remove('hidden');
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            socket.emit('sendMessage', { message });
            input.value = '';
        }

        function addChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            const div = document.createElement('div');
            div.className = 'chat-message';
            
            const time = new Date(message.timestamp).toLocaleTimeString();
            div.innerHTML = `
                <span class="chat-username">${message.username}</span>
                <span style="font-size: 12px; color: #6c757d; margin-left: 10px;">${time}</span>
                <div style="margin-top: 3px;">${message.message}</div>
            `;
            
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function checkEnvironment() {
            // URLパラメータでテスト環境を判定（本来は環境変数を使用）
            const isProduction = !window.location.hostname.includes('localhost') && 
                                !window.location.hostname.includes('127.0.0.1') &&
                                !window.location.search.includes('test=1');
            
            if (!isProduction) {
                document.getElementById('testArea').classList.remove('hidden');
            }
        }

        function sendTestScore() {
            const normalScore = parseInt(document.getElementById('testNormalScore').value) || 0;
            const exScore = parseInt(document.getElementById('testExScore').value) || 0;
            
            if (normalScore === 0 && exScore === 0) {
                alert('スコアを入力してください');
                return;
            }

            socket.emit('sendTestScore', { normalScore, exScore });
            
            // フォームをクリア
            document.getElementById('testNormalScore').value = '';
            document.getElementById('testExScore').value = '';
        }

        function finishTestSong() {
            socket.emit('finishTestSong');
        }

        function openDuelVisualizer() {
            if (currentRoom) {
                const url = `/duel.html?room=${currentRoom.id}`;
                window.open(url, '_blank', 'width=1200,height=800');
            }
        }

        function openMultiVisualizer() {
            if (currentRoom) {
                const url = `/multi.html?room=${currentRoom.id}`;
                window.open(url, '_blank', 'width=1200,height=600');
            }
        }
    </script>
</body>
</html>